<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Business Card Generator</title>
    <!-- Font Awesome for icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <!-- intl-tel-input CSS for international phone input -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"
    />
    <!-- Quill CSS for rich text editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
    <style>
      :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --neutral-light: rgba(236, 240, 241, 0.9);
        --neutral-dark: #34495e;
        --background-color: #ffffff;
        --text-color: #000000;
      }
      body {
        font-family: 'Segoe UI', system-ui, sans-serif;
        margin: 0;
        padding: 1rem;
        background: var(--background-color);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        position: relative;
        transition: background 0.3s ease, color 0.3s ease;
      }
      .form-container {
        width: 100%;
        max-width: 450px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        padding: 1.5rem;
        margin: 1rem;
        box-sizing: border-box;
        position: relative;
        transition: filter 0.3s ease;
      }
      /* Gear icon */
      .gear-icon {
        position: absolute;
        top: -10px;
        right: 1rem;
        font-size: 1.5rem;
        color: var(--primary-color);
        cursor: pointer;
        transition: transform 0.3s ease, color 0.3s ease;
      }
      .gear-icon:hover {
        color: var(--secondary-color);
        transform: rotate(90deg);
      }
      .form-header {
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        text-align: center;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }
      .input-group label {
        font-weight: 600;
        color: var(--neutral-dark);
      }
      .input-group .required {
        color: var(--accent-color);
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 0.7rem;
        border: 1px solid var(--neutral-light);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
        box-sizing: border-box;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--secondary-color);
        outline: none;
      }
      textarea {
        resize: vertical;
      }
      .error {
        border: 2px solid var(--accent-color);
      }
      .image-upload-group {
        grid-column: 1 / -1;
        text-align: center;
        border: 2px dashed var(--neutral-light);
        padding: 1rem;
        border-radius: 8px;
        cursor: pointer;
        position: relative;
      }
      /* Profile Image Preview */
      #imagePreview {
        width: 50px;
        height: 50px;
        border-radius: 4px;
        object-fit: cover;
        margin: 0.5rem auto;
        display: none;
      }
      #generateCard {
        background: var(--secondary-color);
        color: white;
        width: 100%;
        padding: 0.8rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
      }
      /* Dropdown Menu (existing) */
      .dropdown-menu {
        display: none;
        position: absolute;
        top: 2rem;
        right: -20px;
        background: #fff;
        border: 1px solid var(--neutral-light);
        border-radius: 8px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        padding: 0.5rem;
        width: 80px;
        z-index: 1000;
        text-align: center;
      }
      .dropdown-menu.active {
        display: block;
      }
      .dropdown-menu h4 {
        margin: 0 0 0.3rem;
        font-size: 0.8rem;
        font-family: 'Roboto', sans-serif;
        font-weight: bold;
        background: var(--secondary-color);
        color: #ffffff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.4rem;
        border-radius: 4px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.35);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.25);
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }
      .dropdown-menu h4:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.45);
      }
      .arrow-icon {
        transition: transform 0.3s ease;
        font-size: 0.8rem;
        margin-left: 0.2rem;
      }
      .arrow-icon.rotated {
        transform: rotate(-180deg);
      }
      .dropdown-menu button {
        width: 100%;
        padding: 0.3rem;
        margin: 0.2rem 0;
        background: #ffffff;
        color: var(--secondary-color);
        border: 1px solid var(--neutral-light);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }
      .dropdown-menu button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .sub-dropdown {
        display: none;
        margin: 0.3rem 0;
      }
      .sub-dropdown.active {
        display: block;
      }
      .image-thumbnails,
      .color-thumbnails {
        display: flex;
        gap: 0.3rem;
        overflow-x: auto;
        white-space: nowrap;
        margin-bottom: 0.3rem;
      }
      .image-thumbnails img {
        width: 25px;
        height: 25px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid transparent;
        transition: border-color 0.2s ease;
      }
      .image-thumbnails img:hover {
        border-color: var(--secondary-color);
      }
      .color-thumbnails div {
        width: 25px;
        height: 25px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid transparent;
        transition: border-color 0.2s ease;
      }
      .color-thumbnails div:hover {
        border-color: var(--secondary-color);
      }
      .action-buttons {
        display: none;
        margin-top: 5px;
        display: flex;
        justify-content: center;
      }
      .action-buttons button {
        padding: 0.3rem 0.5rem;
        border: none;
        border-radius: 4px;
        background: var(--secondary-color);
        color: #ffffff;
        cursor: pointer;
        font-size: 0.8rem;
      }
      .glassy-background {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1.5rem;
      }
      /* Quill editor container styling */
      #editor-container {
        height: 200px;
        background: #ffffff;
        border: 1px solid var(--neutral-light);
        border-radius: 6px;
      }
      /* Exclusive Offers Section Styles */
      .exclusive-offers-section {
        border-top: 1px solid var(--neutral-light);
        margin-top: 1rem;
        padding-top: 1rem;
      }
      .exclusive-offers-section h3 {
        margin-bottom: 0.5rem;
        color: var(--primary-color);
        text-align: center;
      }
      .offer-field {
        border: 1px solid var(--neutral-light);
        border-radius: 6px;
        padding: 0.5rem;
        margin-bottom: 0.8rem;
      }
      .offer-field label {
        font-weight: 600;
        color: var(--neutral-dark);
      }
      .offer-field button {
        margin-top: 0.5rem;
        background: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
      }
      .offer-details {
        margin-top: 0.5rem;
        border-top: 1px dashed var(--neutral-light);
        padding-top: 0.5rem;
      }
      .offer-editor {
        height: 120px;
        background: #ffffff;
        border: 1px solid var(--neutral-light);
        border-radius: 4px;
      }
      .offer-style-selection {
        text-align: center;
        margin-top: 1rem;
      }
      #offerStyleBtn {
        background: var(--secondary-color);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
      }
      #offerStyleDropdown {
        margin-top: 0.5rem;
      }
      #offerStyleDropdown button {
        background: #fff;
        border: 1px solid var(--neutral-light);
        padding: 0.3rem 0.6rem;
        margin: 0.2rem;
        border-radius: 4px;
        cursor: pointer;
      }
      #offerPreview {
        margin-top: 0.8rem;
        border: 1px dashed var(--neutral-light);
        padding: 0.5rem;
        min-height: 80px;
      }
      #applyOfferStyleBtn {
        margin-top: 0.5rem;
        background: var(--secondary-color);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
      }
      @media (max-width: 480px) {
        .form-container {
          max-width: 90%;
          padding: 1rem;
        }
      }
    </style>
    <!-- Include Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Firebase and intl-tel-input Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>
  </head>
  <body>
    <div class="form-container glassy-background" id="formContainer">
      <!-- Gear Icon -->
      <div class="gear-icon" onclick="toggleDropdown()">
        <i class="fas fa-cog"></i>
      </div>
      <!-- Dropdown Menu -->
      <div class="dropdown-menu" id="dropdownMenu">
        <h4 onclick="toggleSubDropdown('mood')">
          Mood <i class="fas fa-chevron-down arrow-icon"></i>
        </h4>
        <div id="moodSubDropdown" class="sub-dropdown">
          <button onclick="previewMood('day')">Day</button>
          <button onclick="previewMood('night')">Night</button>
          <div id="moodActionButtons" class="action-buttons">
            <button onclick="applyMood()">Apply</button>
          </div>
        </div>
        <h4 onclick="toggleSubDropdown('theme')">
          Theme <i class="fas fa-chevron-down arrow-icon"></i>
        </h4>
        <div id="themeSubDropdown" class="sub-dropdown">
          <button onclick="previewTheme('default')">Default</button>
          <button onclick="toggleSubDropdown('image')">
            Image <i class="fas fa-chevron-down arrow-icon"></i>
          </button>
          <div id="imageSubDropdown" class="sub-dropdown">
            <div class="image-thumbnails">
              <img src="https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885_1280.jpg" alt="Image 1" onclick="previewTheme('image', this.src)">
              <img src="https://cdn.pixabay.com/photo/2015/12/01/20/28/road-1072821_1280.jpg" alt="Image 2" onclick="previewTheme('image', this.src)">
              <img src="https://cdn.pixabay.com/photo/2016/05/05/02/37/sunset-1373171_1280.jpg" alt="Image 3" onclick="previewTheme('image', this.src)">
              <img src="https://cdn.pixabay.com/photo/2018/08/21/23/29/forest-3622519_1280.jpg" alt="Image 4" onclick="previewTheme('image', this.src)">
              <img src="https://cdn.pixabay.com/photo/2017/02/08/17/24/fantasy-2049567_1280.jpg" alt="Image 5" onclick="previewTheme('image', this.src)">
            </div>
          </div>
          <button onclick="toggleSubDropdown('color')">
            Color <i class="fas fa-chevron-down arrow-icon"></i>
          </button>
          <div id="colorSubDropdown" class="sub-dropdown">
            <div class="color-thumbnails">
              <div style="background-color: #3498db;" onclick="previewTheme('color', '#3498db')"></div>
              <div style="background-color: #e74c3c;" onclick="previewTheme('color', '#e74c3c')"></div>
              <div style="background-color: #2ecc71;" onclick="previewTheme('color', '#2ecc71')"></div>
              <div style="background-color: #9b59b6;" onclick="previewTheme('color', '#9b59b6')"></div>
              <div style="background-color: #f1c40f;" onclick="previewTheme('color', '#f1c40f')"></div>
            </div>
          </div>
          <div id="themeActionButtons" class="action-buttons">
            <button onclick="applyTheme()">Apply</button>
          </div>
        </div>
        <h4 onclick="toggleSubDropdown('style')">
          Style <i class="fas fa-chevron-down arrow-icon"></i>
        </h4>
        <div id="styleSubDropdown" class="sub-dropdown">
          <button onclick="previewStyle('default')">Default</button>
          <button onclick="previewStyle('styleA')">Style A</button>
          <button onclick="previewStyle('styleB')">Style B</button>
          <div id="styleActionButtons" class="action-buttons">
            <button onclick="applyStyle()">Apply</button>
          </div>
        </div>
      </div>
      <!-- Form Header -->
      <div class="form-header">
        <h2>Create Business Card</h2>
        <p>Fill in all required information</p>
      </div>
      <div class="form-grid">
        <div class="image-upload-group">
          <label for="profileImage">
            <i class="fas fa-camera fa-2x"></i>
            <p>Upload Profile Photo</p>
          </label>
          <input type="file" id="profileImage" accept="image/*" onchange="previewImage(event)" />
          <img id="imagePreview" alt="Profile Preview" />
        </div>
        <div class="input-group">
          <label for="name">Full Name <span class="required">*</span></label>
          <input type="text" id="name" placeholder="Full Name" required />
        </div>
        <div class="input-group">
          <label for="businessName">Business Name <span class="required">*</span></label>
          <input type="text" id="businessName" placeholder="Business Name" required />
        </div>
        <!-- Business Info using Quill Editor -->
        <div class="input-group">
          <label for="businessInfo">Business Info <span class="required">*</span></label>
          <!-- Quill editor container -->
          <div id="editor-container"></div>
          <!-- Hidden textarea to store HTML content -->
          <textarea id="businessInfo" name="businessInfo" style="display:none;" required></textarea>
          <small style="color: var(--neutral-dark); font-size: 0.8rem;">
            <strong>Instructions:</strong> Write 3 to 5 paragraphs. Each paragraph must not exceed 150 words. Separate paragraphs with a new line.
          </small>
        </div>
        <div class="input-group">
          <label for="address">Business Address <span class="required">*</span></label>
          <input type="text" id="address" placeholder="Business Address" required />
        </div>
        <div class="input-group">
          <label for="phone">Phone Number <span class="required">*</span></label>
          <input type="tel" id="phone" placeholder="Enter phone number" required />
        </div>
        <div class="input-group">
          <label for="email">Email Address <span class="required">*</span></label>
          <input type="email" id="email" placeholder="Email Address" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="Please enter a valid email address." />
        </div>
        <div class="input-group">
          <label for="facebook">Facebook URL</label>
          <input type="url" id="facebook" placeholder="Facebook URL" pattern="https?://(www\.)?facebook\.com/.*" title="Please enter a valid Facebook URL." />
        </div>
        <div class="input-group">
          <label for="instagram">Instagram URL</label>
          <input type="url" id="instagram" placeholder="Instagram URL" pattern="https?://(www\.)?instagram\.com/.*" title="Please enter a valid Instagram URL." />
        </div>
        <div class="input-group">
          <label for="youtube">YouTube URL</label>
          <input type="url" id="youtube" placeholder="YouTube URL" pattern="https?://(www\.)?youtube\.com/.*" title="Please enter a valid YouTube URL." />
        </div>
      </div>
      <!-- Exclusive Offers Section -->
      <div class="exclusive-offers-section">
        <h3>Exclusive Offers</h3>
        <div id="offersContainer">
          <!-- Offer 1 -->
          <div class="offer-field" id="offerField1">
            <label>Offer 1</label>
            <button type="button" onclick="toggleOfferDetails(1)">Add Details</button>
            <div class="offer-details" id="offerDetailsContainer1" style="display:none;">
              <div id="offerEditor1" class="offer-editor"></div>
              <textarea id="offerText1" name="offerText1" style="display:none;"></textarea>
              <input type="file" id="offerFile1" accept="image/*" onchange="previewOfferFile(event,1)" />
              <img id="offerFilePreview1" src="" alt="Offer File Preview" style="display:none; width:50px; height:50px;" />
            </div>
          </div>
          <!-- Offer 2 -->
          <div class="offer-field" id="offerField2">
            <label>Offer 2</label>
            <button type="button" onclick="toggleOfferDetails(2)">Add Details</button>
            <div class="offer-details" id="offerDetailsContainer2" style="display:none;">
              <div id="offerEditor2" class="offer-editor"></div>
              <textarea id="offerText2" name="offerText2" style="display:none;"></textarea>
              <input type="file" id="offerFile2" accept="image/*" onchange="previewOfferFile(event,2)" />
              <img id="offerFilePreview2" src="" alt="Offer File Preview" style="display:none; width:50px; height:50px;" />
            </div>
          </div>
          <!-- Offer 3 -->
          <div class="offer-field" id="offerField3">
            <label>Offer 3</label>
            <button type="button" onclick="toggleOfferDetails(3)">Add Details</button>
            <div class="offer-details" id="offerDetailsContainer3" style="display:none;">
              <div id="offerEditor3" class="offer-editor"></div>
              <textarea id="offerText3" name="offerText3" style="display:none;"></textarea>
              <input type="file" id="offerFile3" accept="image/*" onchange="previewOfferFile(event,3)" />
              <img id="offerFilePreview3" src="" alt="Offer File Preview" style="display:none; width:50px; height:50px;" />
            </div>
          </div>
          <!-- Offer 4 -->
          <div class="offer-field" id="offerField4">
            <label>Offer 4</label>
            <button type="button" onclick="toggleOfferDetails(4)">Add Details</button>
            <div class="offer-details" id="offerDetailsContainer4" style="display:none;">
              <div id="offerEditor4" class="offer-editor"></div>
              <textarea id="offerText4" name="offerText4" style="display:none;"></textarea>
              <input type="file" id="offerFile4" accept="image/*" onchange="previewOfferFile(event,4)" />
              <img id="offerFilePreview4" src="" alt="Offer File Preview" style="display:none; width:50px; height:50px;" />
            </div>
          </div>
        </div>
        <div class="offer-style-selection">
          <button type="button" id="offerStyleBtn" onclick="toggleOfferStyleDropdown()">Select Offer Style</button>
          <div id="offerStyleDropdown" style="display:none;">
            <button type="button" onclick="selectOfferStyle('accordion')">Accordion Offers</button>
            <button type="button" onclick="selectOfferStyle('horizontal')">Horizontal Scroll</button>
            <button type="button" onclick="selectOfferStyle('tab')">Tab-based Offers</button>
            <button type="button" onclick="selectOfferStyle('modal')">Modal Popup</button>
          </div>
          <div id="offerPreview"></div>
          <button type="button" id="applyOfferStyleBtn" onclick="applyOfferStyle()" style="display:none;">Apply Offer Style</button>
        </div>
      </div>
      <button id="generateCard">Generate Card</button>
    </div>
    <script>
      // Initialize main Quill Editor for Business Info
      var quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ font: [] }, { size: [] }],
            ['bold', 'italic', 'underline'],
            [{ color: [] }, { background: [] }],
            [{ align: [] }],
            ['clean']
          ]
        }
      });
      
      // Firebase configuration – replace with your own details.
      var firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };
      firebase.initializeApp(firebaseConfig);
      
      var phoneInput = document.querySelector("#phone");
      var iti = window.intlTelInput(phoneInput, {
        initialCountry: "auto",
        separateDialCode: true,
        geoIpLookup: function(success, failure) {
          fetch('https://ipinfo.io/json?token=YOUR_TOKEN')
            .then(resp => resp.json())
            .then(data => success(data.country))
            .catch(() => success("us"));
        },
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
      });
      
      function previewImage(event) {
        const reader = new FileReader();
        const preview = document.getElementById('imagePreview');
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(event.target.files[0]);
      }
      
      function resizeImage(file, callback) {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = function(e) {
          img.src = e.target.result;
          img.onload = function() {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 150, MAX_HEIGHT = 150;
            let width = img.width, height = img.height;
            if (width > height) {
              if (width > MAX_WIDTH) {
                height = height * (MAX_WIDTH / width);
                width = MAX_WIDTH;
              }
            } else {
              if (height > MAX_HEIGHT) {
                width = width * (MAX_HEIGHT / height);
                height = MAX_HEIGHT;
              }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(function(blob) { callback(blob); }, 'image/jpeg', 0.4);
          };
        };
        reader.readAsDataURL(file);
      }
      
      // --- Exclusive Offers Code ---
      window.offerEditors = {}; // To hold Quill instances for offers
      var selectedOfferStyle = ""; // Holds the chosen offer style
      
      function toggleOfferDetails(index) {
        var container = document.getElementById('offerDetailsContainer' + index);
        if (container.style.display === "none" || container.style.display === "") {
          container.style.display = "block";
          // Initialize Quill editor if not already initialized
          if (!window.offerEditors[index]) {
            window.offerEditors[index] = new Quill('#offerEditor' + index, {
              theme: 'snow',
              modules: {
                toolbar: [
                  [{ font: [] }, { size: [] }],
                  ['bold', 'italic', 'underline'],
                  [{ color: [] }, { background: [] }],
                  [{ align: [] }],
                  ['clean']
                ]
              }
            });
          }
        } else {
          container.style.display = "none";
        }
      }
      
      function previewOfferFile(event, index) {
        const reader = new FileReader();
        const preview = document.getElementById('offerFilePreview' + index);
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(event.target.files[0]);
      }
      
      function toggleOfferStyleDropdown() {
        var dropdown = document.getElementById('offerStyleDropdown');
        dropdown.style.display = dropdown.style.display === "none" || dropdown.style.display === "" ? "block" : "none";
      }
      
      function selectOfferStyle(style) {
        selectedOfferStyle = style;
        // Show preview of the selected style in the offerPreview div
        showOfferPreview(style);
        document.getElementById('applyOfferStyleBtn').style.display = "inline-block";
      }
      
      function showOfferPreview(style) {
        var previewDiv = document.getElementById('offerPreview');
        // Simple preview markup for each style – this can be extended as needed.
        if (style === "accordion") {
          previewDiv.innerHTML = '<div style="border:1px solid #ccc; padding:10px;">Accordion Preview: Click header to reveal offer details.</div>';
        } else if (style === "horizontal") {
          previewDiv.innerHTML = '<div style="overflow-x:auto; white-space:nowrap; border:1px solid #ccc; padding:10px;">' +
            '<div style="display:inline-block; width:100px; height:80px; background:#3498db; margin-right:5px; color:#fff; text-align:center; line-height:80px;">Offer 1</div>' +
            '</div>';
        } else if (style === "tab") {
          previewDiv.innerHTML = '<div style="border:1px solid #ccc; padding:10px;">Tab Preview: Click tabs to switch offers.</div>';
        } else if (style === "modal") {
          previewDiv.innerHTML = '<div style="border:1px solid #ccc; padding:10px;">Modal Preview: Click offer to open modal.</div>';
        } else {
          previewDiv.innerHTML = '';
        }
      }
      
      function applyOfferStyle() {
        alert("Offer style '" + selectedOfferStyle + "' applied.");
        document.getElementById('offerStyleDropdown').style.display = "none";
      }
      
      // --- End Exclusive Offers Code ---
      
      function validateForm() {
        let valid = true;
        const fieldIds = ['name', 'businessName', 'address', 'email'];
        fieldIds.forEach(function(id) {
          const field = document.getElementById(id);
          if (field) field.classList.remove('error');
        });
        fieldIds.forEach(function(id) {
          const field = document.getElementById(id);
          if (!field.value.trim()) { valid = false; field.classList.add('error'); }
        });
        if (!valid) { alert("Please fill all required fields."); return false; }
        if (!iti.isValidNumber()) { 
          phoneInput.classList.add('error'); 
          alert("Please enter a valid phone number."); 
          return false; 
        }
        const emailValue = document.getElementById('email').value.trim();
        if (!/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i.test(emailValue)) {
          document.getElementById('email').classList.add('error');
          alert("Please enter a valid email address.");
          return false;
        }
        const socialMedia = [
          { id: 'facebook', regex: /^https?:\/\/(www\.)?facebook\.com\/.+$/i, message: "Please enter a valid Facebook URL." },
          { id: 'instagram', regex: /^https?:\/\/(www\.)?instagram\.com\/.+$/i, message: "Please enter a valid Instagram URL." },
          { id: 'youtube', regex: /^https?:\/\/(www\.)?youtube\.com\/.+$/i, message: "Please enter a valid YouTube URL." }
        ];
        socialMedia.forEach(function(sm) {
          const value = document.getElementById(sm.id).value.trim();
          if (value && !sm.regex.test(value)) { 
            document.getElementById(sm.id).classList.add('error'); 
            alert(sm.message); 
            valid = false; 
          }
        });
        if (!valid) return false;
        // Copy the Quill editor content into the hidden textarea for business info.
        document.getElementById('businessInfo').value = quill.root.innerHTML;
        return true;
      }
      
      function uploadOfferFile(file) {
        return new Promise(function(resolve, reject) {
          resizeImage(file, function(resizedBlob) {
            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child('offer_images/' + Date.now() + '.jpg');
            imageRef.put(resizedBlob).then(function(snapshot) {
              return snapshot.ref.getDownloadURL();
            }).then(function(url) {
              resolve(url);
            }).catch(function(error) {
              reject(error);
            });
          });
        });
      }
      
      function uploadImageToFirebase(blob, formData) {
        const storageRef = firebase.storage().ref();
        const imageRef = storageRef.child('profile_images/' + Date.now() + '.jpg');
        imageRef.put(blob).then(function(snapshot) {
          return snapshot.ref.getDownloadURL();
        }).then(function(url) {
          formData.profileImage = url;
          proceedToCard(formData);
        }).catch(function(error) {
          console.error('Error uploading image:', error);
          alert('Image upload failed. Please try again.');
        });
      }
      
      document.getElementById('generateCard').onclick = function () {
        if (!validateForm()) return;
        let formData = {
          name: document.getElementById('name').value.trim(),
          businessName: document.getElementById('businessName').value.trim(),
          businessInfo: document.getElementById('businessInfo').value.trim(),
          address: document.getElementById('address').value.trim(),
          phone: iti.getNumber(),
          email: document.getElementById('email').value.trim(),
          facebook: document.getElementById('facebook').value.trim(),
          instagram: document.getElementById('instagram').value.trim(),
          youtube: document.getElementById('youtube').value.trim()
        };
        // Gather Exclusive Offers Data
        let offers = [];
        let uploadPromises = [];
        for (let i = 1; i <= 4; i++) {
          let offer = {};
          if (window.offerEditors[i]) {
            offer.details = window.offerEditors[i].root.innerHTML;
          } else {
            offer.details = "";
          }
          let fileInput = document.getElementById('offerFile' + i);
          if (fileInput && fileInput.files[0]) {
            let file = fileInput.files[0];
            // Use a closure to capture current index offer
            let promise = uploadOfferFile(file).then(function(url) {
              offer.file = url;
            }).catch(function() {
              offer.file = "";
            });
            uploadPromises.push(promise);
          } else {
            offer.file = "";
          }
          offers.push(offer);
        }
        // Save selected offer style
        formData.offers = offers;
        formData.offerStyle = selectedOfferStyle;
        
        // Handle profile image upload if any
        const profileImageFile = document.getElementById('profileImage').files[0];
        if (profileImageFile) {
          resizeImage(profileImageFile, function(resizedBlob) {
            uploadImageToFirebase(resizedBlob, formData);
          });
        } else {
          // Wait for any offer file uploads to complete then proceed
          Promise.all(uploadPromises).then(function() {
            proceedToCard(formData);
          });
        }
      };
      
      function proceedToCard(formData) {
        // Store formData in localStorage and redirect to card.html
        localStorage.setItem('formData', JSON.stringify(formData));
        window.location.href = "card.html";
      }
      
      function toggleDropdown() {
        const dropdownMenu = document.getElementById('dropdownMenu');
        dropdownMenu.classList.toggle('active');
      }
      
      function toggleSubDropdown(id) {
        const header = document.querySelector('h4[onclick*="' + id + '"]');
        const subDropdown = document.getElementById(id + 'SubDropdown');
        subDropdown.classList.toggle('active');
        if(header) {
          const arrow = header.querySelector('.arrow-icon');
          if (arrow) arrow.classList.toggle('rotated');
        }
      }
    </script>
  </body>
</html>
