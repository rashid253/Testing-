<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Card Generator</title>
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <!-- intl-tel-input CSS for international phone input -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
  <!-- Quill CSS for rich text editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2C3E50;
      --secondary-color: #3498DB;
      --accent-color: #E74C3E;
      --neutral-light: rgba(236,240,241,0.9);
      --neutral-dark: #34495E;
      --background-color: #ffffff;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--background-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .form-container {
      width: 100%;
      max-width: 450px;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      padding: 1.5rem;
      margin: 1rem;
      box-sizing: border-box;
    }
    .form-header {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 1.5rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .input-group label {
      font-weight: 600;
      color: var(--neutral-dark);
    }
    .input-group .required {
      color: var(--accent-color);
    }
    input, select, textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid var(--neutral-light);
      border-radius: 6px;
      font-size: 0.9rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--secondary-color);
      outline: none;
    }
    textarea {
      resize: vertical;
    }
    .error {
      border: 2px solid var(--accent-color);
    }
    .image-upload-group {
      text-align: center;
      border: 2px dashed var(--neutral-light);
      padding: 1rem;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
    }
    #imagePreview {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      object-fit: cover;
      margin: 0.5rem auto;
      display: none;
    }
    /* Exclusive Offers Section */
    .exclusive-offers {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 2px solid var(--secondary-color);
    }
    .exclusive-offers h3 {
      text-align: center;
      color: var(--primary-color);
    }
    .offer-item {
      border: 1px solid var(--neutral-light);
      border-radius: 8px;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    .offer-item .offer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .offer-item .toggle-details-btn {
      background: var(--secondary-color);
      color: #fff;
      border: none;
      padding: 0.3rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .offer-details {
      display: none;
      margin-top: 0.5rem;
    }
    .offer-style-select {
      margin-top: 1rem;
      text-align: center;
    }
    .offer-style-select select {
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid var(--neutral-light);
    }
    .offer-preview {
      margin-top: 1rem;
      text-align: center;
    }
    .offer-preview .flip-card {
      width: 90%;
      max-width: 300px;
      margin: 0 auto;
      max-height: 25vh;
      perspective: 1000px;
      cursor: pointer;
    }
    .offer-preview .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .offer-preview .flip-card:hover .flip-card-inner {
      transform: rotateY(180deg);
    }
    .offer-preview .flip-card-front, .offer-preview .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      box-sizing: border-box;
      color: #fff;
      font-size: 1rem;
      text-align: center;
    }
    .offer-preview .flip-card-front {
      background: var(--secondary-color);
    }
    .offer-preview .flip-card-back {
      background: var(--accent-color);
      transform: rotateY(180deg);
    }
    .apply-offers-btn {
      margin-top: 1rem;
      background: var(--secondary-color);
      color: #fff;
      border: none;
      padding: 0.7rem;
      border-radius: 6px;
      width: 100%;
      cursor: pointer;
      font-size: 1rem;
    }
    #generateCard {
      background: var(--secondary-color);
      color: white;
      width: 100%;
      padding: 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 1rem;
    }
  </style>
  <!-- Include Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>
  <div class="form-container" id="formContainer">
    <div class="form-header">
      <h2>Create Business Card</h2>
      <p>Fill in all required information</p>
    </div>
    <div class="form-grid">
      <div class="image-upload-group">
        <label for="profileImage">
          <i class="fas fa-camera fa-2x"></i>
          <p>Upload Profile Photo</p>
        </label>
        <input type="file" id="profileImage" accept="image/*" onchange="previewImage(event)" />
        <img id="imagePreview" alt="Profile Preview" />
      </div>
      <div class="input-group">
        <label for="name">Full Name <span class="required">*</span></label>
        <input type="text" id="name" placeholder="Full Name" required />
      </div>
      <div class="input-group">
        <label for="businessName">Business Name <span class="required">*</span></label>
        <input type="text" id="businessName" placeholder="Business Name" required />
      </div>
      <div class="input-group">
        <label for="businessInfo">Business Info <span class="required">*</span></label>
        <div id="editor-container"></div>
        <textarea id="businessInfo" style="display:none;" required></textarea>
        <small style="color: var(--neutral-dark); font-size: 0.8rem;">
          Write 3 to 5 paragraphs (each not more than 150 words). Separate paragraphs with new lines.
        </small>
      </div>
      <div class="input-group">
        <label for="address">Business Address <span class="required">*</span></label>
        <input type="text" id="address" placeholder="Business Address" required />
      </div>
      <div class="input-group">
        <label for="phone">Phone Number <span class="required">*</span></label>
        <input type="tel" id="phone" placeholder="Enter phone number" required />
      </div>
      <div class="input-group">
        <label for="email">Email Address <span class="required">*</span></label>
        <input type="email" id="email" placeholder="Email Address" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" />
      </div>
      <div class="input-group">
        <label for="facebook">Facebook URL</label>
        <input type="url" id="facebook" placeholder="Facebook URL" />
      </div>
      <div class="input-group">
        <label for="instagram">Instagram URL</label>
        <input type="url" id="instagram" placeholder="Instagram URL" />
      </div>
      <div class="input-group">
        <label for="youtube">YouTube URL</label>
        <input type="url" id="youtube" placeholder="YouTube URL" />
      </div>
    </div>
    <!-- Exclusive Offers Section -->
    <div class="exclusive-offers">
      <h3>Exclusive Offers</h3>
      <!-- Four offer items -->
      <div class="offer-item" id="offerItem1">
        <div class="offer-header">
          <input type="text" id="offerTitle1" placeholder="Offer 1 Title" />
          <button type="button" class="toggle-details-btn" onclick="toggleOfferDetails(1)">Details</button>
        </div>
        <div class="offer-details" id="offerDetailsContainer1">
          <div id="offerDetailsEditor1" style="height:100px;"></div>
          <textarea id="offerDetails1" style="display:none;"></textarea>
          <input type="file" id="offerFile1" accept="image/*" />
        </div>
      </div>
      <div class="offer-item" id="offerItem2">
        <div class="offer-header">
          <input type="text" id="offerTitle2" placeholder="Offer 2 Title" />
          <button type="button" class="toggle-details-btn" onclick="toggleOfferDetails(2)">Details</button>
        </div>
        <div class="offer-details" id="offerDetailsContainer2">
          <div id="offerDetailsEditor2" style="height:100px;"></div>
          <textarea id="offerDetails2" style="display:none;"></textarea>
          <input type="file" id="offerFile2" accept="image/*" />
        </div>
      </div>
      <div class="offer-item" id="offerItem3">
        <div class="offer-header">
          <input type="text" id="offerTitle3" placeholder="Offer 3 Title" />
          <button type="button" class="toggle-details-btn" onclick="toggleOfferDetails(3)">Details</button>
        </div>
        <div class="offer-details" id="offerDetailsContainer3">
          <div id="offerDetailsEditor3" style="height:100px;"></div>
          <textarea id="offerDetails3" style="display:none;"></textarea>
          <input type="file" id="offerFile3" accept="image/*" />
        </div>
      </div>
      <div class="offer-item" id="offerItem4">
        <div class="offer-header">
          <input type="text" id="offerTitle4" placeholder="Offer 4 Title" />
          <button type="button" class="toggle-details-btn" onclick="toggleOfferDetails(4)">Details</button>
        </div>
        <div class="offer-details" id="offerDetailsContainer4">
          <div id="offerDetailsEditor4" style="height:100px;"></div>
          <textarea id="offerDetails4" style="display:none;"></textarea>
          <input type="file" id="offerFile4" accept="image/*" />
        </div>
      </div>
      <!-- Offer Style Selection -->
      <div class="offer-style-select">
        <label for="offerStyleSelect"><strong>Select Offer Style:</strong></label>
        <select id="offerStyleSelect">
          <option value="accordion">Accordion Offers</option>
          <option value="horizontal">Horizontal Scroll Offers</option>
          <option value="tab">Tab-Based Offers</option>
          <option value="modal">Modal Popup Offers</option>
        </select>
      </div>
      <!-- Offer Preview (simple flip-card preview) -->
      <div class="offer-preview" id="offerPreviewArea">
        <div class="flip-card" id="offerPreviewCard">
          <div class="flip-card-inner">
            <div class="flip-card-front">Offer Title Preview</div>
            <div class="flip-card-back">Offer Details Preview</div>
          </div>
        </div>
      </div>
      <button type="button" class="apply-offers-btn" onclick="applyExclusiveOffers()">Apply Offers</button>
    </div>
    
    <button id="generateCard">Generate Card</button>
  </div>
  
  <!-- Firebase and intl-tel-input Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>
  <script>
    // Initialize Quill Editor for business info
    var quill = new Quill('#editor-container', {
      theme: 'snow',
      modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'color': [] }], [{ 'align': [] }], ['clean']] }
    });
    // Initialize Quill Editors for each offer details (1 to 4)
    var quillOffers = {};
    for (let i = 1; i <= 4; i++) {
      quillOffers[i] = new Quill('#offerDetailsEditor' + i, {
        theme: 'snow',
        modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'color': [] }], [{ 'align': [] }], ['clean']] }
      });
    }
    
    // Firebase configuration – REPLACE with your actual credentials.
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    
    var phoneInput = document.querySelector("#phone");
    var iti = window.intlTelInput(phoneInput, {
      initialCountry: "auto",
      separateDialCode: true,
      geoIpLookup: function(success, failure) {
        fetch('https://ipinfo.io/json?token=YOUR_TOKEN')
          .then(resp => resp.json())
          .then(data => success(data.country))
          .catch(() => success("us"));
      },
      utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    });
    
    function previewImage(event) {
      const reader = new FileReader();
      const preview = document.getElementById('imagePreview');
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(event.target.files[0]);
    }
    
    function resizeImage(file, callback) {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = function(e) {
        img.src = e.target.result;
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const MAX_WIDTH = 150, MAX_HEIGHT = 150;
          let width = img.width, height = img.height;
          if (width > height) {
            if (width > MAX_WIDTH) {
              height = height * (MAX_WIDTH / width);
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width = width * (MAX_HEIGHT / height);
              height = MAX_HEIGHT;
            }
          }
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob(function(blob) { callback(blob); }, 'image/jpeg', 0.4);
        };
      };
      reader.readAsDataURL(file);
    }
    
    function toggleOfferDetails(num) {
      const container = document.getElementById('offerDetailsContainer' + num);
      container.style.display = (container.style.display === "block") ? "none" : "block";
    }
    
    // Process exclusive offers: returns a promise that resolves with an array of offers
    function processExclusiveOffers() {
      let offers = [];
      let promises = [];
      for (let i = 1; i <= 4; i++) {
        const title = document.getElementById('offerTitle' + i).value.trim();
        const detailsHTML = quillOffers[i].root.innerHTML;
        document.getElementById('offerDetails' + i).value = detailsHTML;
        const details = document.getElementById('offerDetails' + i).value;
        const fileInput = document.getElementById('offerFile' + i);
        let offerData = { title, details, fileUrl: "" };
        if (fileInput.files[0]) {
          promises.push(new Promise((resolve, reject) => {
            resizeImage(fileInput.files[0], function(resizedBlob) {
              const storageRef = firebase.storage().ref();
              const imageRef = storageRef.child('offer_images/' + Date.now() + '.jpg');
              imageRef.put(resizedBlob).then(function(snapshot) {
                snapshot.ref.getDownloadURL().then(function(url) {
                  offerData.fileUrl = url;
                  offers[i - 1] = offerData;
                  resolve();
                });
              }).catch(reject);
            });
          }));
        } else {
          offers[i - 1] = offerData;
        }
      }
      return Promise.all(promises).then(() => offers);
    }
    
    // Update preview flip-card based on selected offer style from dropdown
    document.getElementById('offerStyleSelect').addEventListener('change', function() {
      const style = this.value;
      const previewCard = document.getElementById('offerPreviewCard');
      if (style === 'accordion') {
        previewCard.querySelector('.flip-card-front').textContent = "Accordion Offer";
        previewCard.querySelector('.flip-card-back').textContent = "Details in Accordion style";
      } else if (style === 'horizontal') {
        previewCard.querySelector('.flip-card-front').textContent = "Horizontal Scroll Offer";
        previewCard.querySelector('.flip-card-back').textContent = "Details in Horizontal style";
      } else if (style === 'tab') {
        previewCard.querySelector('.flip-card-front').textContent = "Tab-Based Offer";
        previewCard.querySelector('.flip-card-back').textContent = "Details in Tab style";
      } else if (style === 'modal') {
        previewCard.querySelector('.flip-card-front').textContent = "Modal Popup Offer";
        previewCard.querySelector('.flip-card-back').textContent = "Details in Modal style";
      }
    });
    
    function applyExclusiveOffers() {
      processExclusiveOffers().then(function(offers) {
        let formData = JSON.parse(localStorage.getItem('formData')) || {};
        formData.exclusiveOffers = offers;
        formData.offerStyle = document.getElementById('offerStyleSelect').value;
        localStorage.setItem('formData', JSON.stringify(formData));
        alert("Exclusive Offers applied! Preview updated.");
      }).catch(function(err) {
        console.error("Error processing exclusive offers:", err);
        alert("Failed to process exclusive offers. Please try again.");
      });
    }
    
    function validateForm() {
      let valid = true;
      const fieldIds = ['name', 'businessName', 'address', 'email'];
      fieldIds.forEach(function(id) {
        const field = document.getElementById(id);
        if (field) field.classList.remove('error');
      });
      fieldIds.forEach(function(id) {
        const field = document.getElementById(id);
        if (!field.value.trim()) { valid = false; field.classList.add('error'); }
      });
      if (!valid) { alert("Please fill all required fields."); return false; }
      if (!iti.isValidNumber()) { 
        phoneInput.classList.add('error'); 
        alert("Please enter a valid phone number."); 
        return false; 
      }
      const emailValue = document.getElementById('email').value.trim();
      if (!/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i.test(emailValue)) {
        document.getElementById('email').classList.add('error');
        alert("Please enter a valid email address.");
        return false;
      }
      // Copy Quill editor content to hidden textarea
      document.getElementById('businessInfo').value = quill.root.innerHTML;
      return true;
    }
    
    function redirectToCard(formData) {
      const params = new URLSearchParams();
      for (let key in formData) {
        if (typeof formData[key] === "object") {
          params.set(key, JSON.stringify(formData[key]));
        } else {
          params.set(key, formData[key]);
        }
      }
      window.location.href = `card.html?${params.toString()}`;
    }
    
    document.getElementById('generateCard').onclick = function () {
      if (!validateForm()) return;
      let formData = {
        name: document.getElementById('name').value.trim(),
        businessName: document.getElementById('businessName').value.trim(),
        businessInfo: document.getElementById('businessInfo').value.trim(),
        address: document.getElementById('address').value.trim(),
        phone: iti.getNumber(),
        email: document.getElementById('email').value.trim(),
        facebook: document.getElementById('facebook').value.trim(),
        instagram: document.getElementById('instagram').value.trim(),
        youtube: document.getElementById('youtube').value.trim()
      };
      localStorage.setItem('formData', JSON.stringify(formData));
      if (document.getElementById('profileImage').files[0]) {
        resizeImage(document.getElementById('profileImage').files[0], function(resizedBlob) {
          const storageRef = firebase.storage().ref();
          const imageRef = storageRef.child('profile_images/' + Date.now() + '.jpg');
          imageRef.put(resizedBlob).then(function(snapshot) {
            snapshot.ref.getDownloadURL().then(function(url) {
              formData.profileImage = url;
              redirectToCard(formData);
            });
          }).catch(function(error) {
            console.error('Error uploading profile image:', error);
            alert('Profile image upload failed. Please try again.');
          });
        });
      } else {
        redirectToCard(formData);
      }
    };
  </script>
</body>
</html>
